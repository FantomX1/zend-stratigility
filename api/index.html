<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="zend-stratigility">  
    <link rel="shortcut icon" href="../img/favicon.ico">

    <title>API Reference - zend-stratigility</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/styles-288837cc22.css">

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <span class="navbar-brand">
                <a class="logo-link" href="https://framework.zend.com/" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../img/zf-logo-mark.svg" height="28" alt="Zend Framework" /></a>
                <a href="..">zend-stratigility</a>
            </span>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                
                
                    <li >
                        <a href="../intro/">Intro</a>
                    </li>
                
                
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            

<li >
    <a href="../install/">Installation and Requirements</a>
</li>


                        
                            

<li >
    <a href="../usage/">Usage</a>
</li>


                        
                            

<li >
    <a href="../middleware/">Middleware</a>
</li>


                        
                            

<li >
    <a href="../error-handlers/">Error Handlers</a>
</li>


                        
                            

<li >
    <a href="../creating-middleware/">Creating Middleware</a>
</li>


                        
                            

<li >
    <a href="../executing-middleware/">Composing middleware</a>
</li>


                        
                            

<li class="active">
    <a href="./">API Reference</a>
</li>


                        
                            

  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Migration</a>
    <ul class="dropdown-menu">
        
            

<li >
    <a href="../migration/to-v2/">To Version 2</a>
</li>


        
            

<li >
    <a href="../migration/preparing-for-v3/">Preparing for Version 3</a>
</li>


        
    </ul>
  </li>


                        
                        </ul>
                    </li>
                
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" class="component-toggle" data-toggle="tooltip" data-placement="bottom" title="Show component list">
                        <i class="fa fa-book"></i> Components
                    </a>
                </li>

                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li>
                        <a href="https://github.com/zendframework/zend-stratigility/">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <!-- content:begin -->
    <div id="page-top" class="container docs">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#api-reference">API Reference</a></li>
        
            <li><a href="#http-middleware">http-middleware</a></li>
        
            <li><a href="#middleware">Middleware</a></li>
        
            <li><a href="#next">Next</a></li>
        
            <li><a href="#http-messages">HTTP Messages</a></li>
        
            <li><a href="#middleware_1">Middleware</a></li>
        
            <li><a href="#middleware-decorators">Middleware Decorators</a></li>
        
            <li><a href="#delegates">Delegates</a></li>
        
            <li><a href="#utility-functions">Utility Functions</a></li>
        
    
    </ul>

    
    <ul class="pager hidden-print">
      <li class="previous">
        <a rel="prev" href="../executing-middleware/"><i class="fa fa-arrow-left"></i> Previous</a>
      </li>
      <li class="next">
        <a rel="next" href="../migration/to-v2/">Next <i class="fa fa-arrow-right"></i></a>
      </li>
    </ul>
    
</div></div>
        <div class="col-md-9" role="main">

<ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="..">zend-stratigility</a></li>
  
    
      
        <li>Reference</li>
      
    
  
  <li class="active">API Reference</li>
</ol>

<h1 id="api-reference">API Reference</h1>
<p>The following make up the primary API of Stratigility.</p>
<blockquote>
<h3 id="http-middleware">http-middleware</h3>
<p>Stratigility has supported http-interop/http-middleware since version 2.0.0,
originally pinning to the 0.4.1 specification.</p>
<p>Starting with version 2.1.0, we also support the 0.5.0 specification. In
operation, they work identically. However, the namespace has changed, 
<code>DelegateInterface</code> was renamed to <code>RequestHandlerInterface</code>, and the
delegate/handler's <code>process()</code> method was renamed to <code>handle()</code>.</p>
<p>Internally, we use the package
<a href="https://github.com/webimpress/http-middleware-compatility">webimpress/http-middleware-compatility</a>
to adapt middleware to work with any http-middleware version.  This package
provides polyfills for the various http-middleware versions, and a "trick" for
calling on the delegate/handler in a way that will work with any http-middleware
version that library supports.</p>
<p>When you write your application, you will need to be aware of what version of
http-middleware you have installed, and write your middleware to target it.</p>
<p>Alternately, you can use the interfaces defined in
webimpress/http-middleware-compatility; read that package's documentation to
understand how you can do so.</p>
</blockquote>
<h2 id="middleware">Middleware</h2>
<p><code>Zend\Stratigility\MiddlewarePipe</code> is the primary application interface, and
has been discussed previously. Its API is:</p>
<pre class="codehilite"><code class="language-php">namespace Zend\Stratigility;

// If http-interop/http-middleware 0.2 is installed:
use Interop\Http\Middleware\DelegateInterface;
use Interop\Http\Middleware\ServerMiddlewareInterface;

// If http-interop/http-middleware 0.4.1 is installed:
use Interop\Http\ServerMiddleware\DelegateInterface;
use Interop\Http\ServerMiddleware\MiddlewareInterface as ServerMiddlewareInterface;

// If http-interop/http-middleware 0.5.0 is installed:
use Interop\Http\Server\MiddlewareInterface as ServerMiddlewareInterface;
use Interop\Http\Server\RequestHandlerInterface as DelegateInterface;

use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;

class MiddlewarePipe implements ServerMiddlewareInterface
{
    public function pipe(
        string|callable|ServerMiddlewareInterface $path,
        callable|ServerMiddlewareInterface $middleware = null
    );

    public function __invoke(
        ServerRequestInterface $request,
        ResponseInterface $response,
        $delegate
    ) : ResponseInterface;

    public function process(
        ServerRequestInterface $request,
        DelegateInterface $delegate
    ) : ResponseInterface;
}</code></pre>

<p><code>pipe()</code> takes up to two arguments. If only one argument is provided,
<code>$middleware</code> will be assigned that value, and <code>$path</code> will be re-assigned to
the value <code>/</code>; this is an indication that the <code>$middleware</code> should be invoked
for any path. If <code>$path</code> is provided, the <code>$middleware</code> will only be executed
for that path and any subpaths.</p>
<blockquote>
<h3 id="use-the-pathmiddlewaredecorator-to-segregate-middleware-by-path">Use the PathMiddlewareDecorator to segregate middleware by path</h3>
<ul>
<li>Since 2.2.0</li>
</ul>
<p>Starting in 2.2.0, we have deprecated the 2-argument form of <code>pipe()</code>, as
version 3 will use only one argument, typehinted against the PSR-15
<code>MiddlewareInterface</code>. Version 2.2.0 introduces a decorator for accomplishing
the same functionality:</p>
<pre class="codehilite"><code class="language-php">use Zend\Stratigility\Middleware\PathMiddlewareDecorator;

$pipeline-&gt;pipe(new PathMiddlewareDecorator($path, $middleware));</code></pre>

<p>If you continue to use the 2-argument form of <code>pipe()</code>, internally it will
decorate your middleware regardless &mdash; and also trigger a deprecation
error. To avoid the deprecation error, update your code today!</p>
<h3 id="request-path-changes-when-path-matched">Request path changes when path matched</h3>
<p>When you pipe middleware using a path (other than '' or '/') or use the
<code>PathMiddlewareDecorator</code> (as outlined in the previous note), the middleware
is dispatched with a request that strips the matched segment(s) from the start
of the path.</p>
<p>If, for example, you executed <code>$pipeline-&gt;pipe('/api', $api)</code>, and this was
matched via a URI with the path <code>/api/users/foo</code>, the <code>$api</code> middleware will
receive a request with the path <code>/users/foo</code>. This allows middleware
segregated by path to be re-used without changes to its own internal routing.</p>
</blockquote>
<p>Middleware is executed in the order in which it is piped to the
<code>MiddlewarePipe</code> instance.</p>
<p>The <code>MiddlewarePipe</code> is itself middleware, and can be executed in stacks that
expect the <code>__invoke()</code> signature (via the <code>__invoke()</code> signature), or stacks
expecting http-interop middleware signatures (via the <code>process()</code> method).</p>
<blockquote>
<h3 id="invocation-is-deprecated">Invocation is deprecated</h3>
<p>Starting in version 2.2.0, invocation via <code>__invoke()</code> is deprecated.</p>
</blockquote>
<p>When using <code>__invoke()</code>, the callable <code>$out</code> argument should either implement
delegator/request handler interface from <code>http-interop/http-middleware</code>
(depends on version you are using), or use the signature:</p>
<pre class="codehilite"><code class="language-php">use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;

function (
    ServerRequestInterface $request,
    ResponseInterface $response
) : ResponseInterface</code></pre>

<p>Most often, you can pass an instance of <code>Zend\Stratigility\NoopFinalHandler</code> for
<code>$out</code> if invoking a middleware pipeline manually; otherwise, a suitable
callback will be provided for you (typically an instance of
<code>Zend\Stratigility\Next</code>, which <code>MiddlewarePipe</code> creates internally before
dispatching to the various middleware in its pipeline).</p>
<p>Middleware should either return a response, or the result of
<code>$next()/DelegateInterface::process()/RequestHandlerInterface::handle()</code>
(which should eventually evaluate to a response instance).</p>
<p>Within Stratigility, <code>Zend\Stratigility\Next</code> provides an implementation
compatible with either usage.</p>
<p>Starting in version 1.3.0, <code>MiddlewarePipe</code> implements the
http-interop/http-middleware server-side middleware interface, and thus provides
a <code>process()</code> method. This method requires a <code>ServerRequestInterface</code> instance
and an http-interop/http-middleware <code>DelegateInterface</code> instance on invocation;
the latter can be a <code>Next</code> instance, as it also implements that interface.</p>
<p>Internally, for both <code>__invoke()</code> and <code>process()</code>, <code>MiddlewarePipe</code> creates an
instance of <code>Zend\Stratigility\Next</code> (feeding it its queue), executes it, and
returns its response.</p>
<h3 id="response-prototype">Response prototype</h3>
<p>Starting in version 1.3.0, you can compose a "response prototype" in the
<code>MiddlewarePipe</code>. When present, any callable middleware piped to the instance
will be wrapped in a decorator (see the <a href="#middleware-decorators">section on middleware
decorators</a>, below) such that it will now conform to
http-interop middleware interfaces.</p>
<p>To use this functionality, inject the prototype before piping middleware:</p>
<pre class="codehilite"><code class="language-php">$pipeline = new MiddlewarePipe();
$pipeline-&gt;setResponsePrototype(new Response());</code></pre>

<blockquote>
<h3 id="response-prototype-deprecated">Response prototype deprecated</h3>
<p>Starting in version 2.2.0, the <code>setResponsePrototype()</code> method is deprecated.
This is because version 3 will no longer accept non-PSR-15 middleware.
Callable middleware will need to be decorated using one of
<code>CallableMiddlewareDecorator</code> (for callable middleware implementing the PSR-15
signature) or <code>DoublePassMiddlewareDecorator</code> (for callable middleware expecting
a response and <code>$next</code> argument). The latter decorator expects a response
prototype as its second argument.</p>
</blockquote>
<h2 id="next">Next</h2>
<p><code>Zend\Stratigility\Next</code> is primarily an implementation detail of middleware,
and exists to allow delegating to middleware registered later in the stack. It
is implemented both as a functor and as an http-interop/http-middleware
<code>DelegateInterface</code> and http-interop/http-server-handler
<code>RequestHandlerInterface</code>.</p>
<h3 id="functor-invocation">Functor invocation</h3>
<p>Because <code>Psr\Http\Message</code>'s interfaces are immutable, if you make changes to
your Request and/or Response instances, you will have new instances, and will
need to make these known to the next middleware in the chain. <code>Next</code> expects
these arguments for every invocation.</p>
<pre class="codehilite"><code class="language-php">class Next
{
    public function __invoke(
        Psr\Http\Message\ServerRequestInterface $request,
        Psr\Http\Message\ResponseInterface $response
    ) : Psr\Http\Message\ResponseInterface;
}</code></pre>

<p>You should <strong>always</strong> either capture or return the return value of <code>$next()</code>
when calling it in your application, or return a response yourself.</p>
<blockquote>
<h3 id="response-argument">$response argument</h3>
<p>Using the <code>$response</code> argument is unsafe when using delegation, as an inner
layer could return an entirely different response, ignoring any changes you
may have introduced previously. Additionally, when manipulating the response
from an inner layer, you may be inheriting unwanted context.</p>
<p>As such, we recommend ignoring the <code>$response</code> argument and doing one of the
following:</p>
<ul>
<li>For innermost middleware that will be returning a response without
  delegation, we recommend instantiating and returning a concrete
  response instance. <a href="https://docs.zendframework.com/zend-diactoros/custom-responses/">Diactoros provides a number of convenient custom responses</a>.</li>
<li>For middleware delegating to another layer, operate on the <em>returned</em>
  response instead:</li>
</ul>
<pre class="codehilite"><code class="language-php">$response = $next($request, $response);
return $response-&gt;withHeader('X-Foo', 'Bar');</code></pre>

</blockquote>
<h3 id="delegate-invocation">Delegate invocation</h3>
<ul>
<li>Since 1.3.0.</li>
</ul>
<p>When invoked as a <code>DelegateInterface</code>, the <code>process()</code> method will be invoked, and
passed a <code>ServerRequestInterface</code> instance <em>only</em>. If you need to return a response,
you will need to:</p>
<ul>
<li>Compose a response prototype in the middleware to use to build a response, or a
  canned response to return, OR</li>
<li>Create and return a concrete response type, OR</li>
<li>Operate on a response returned by invoking the delegate.</li>
</ul>
<h3 id="requesthandler-invocation">RequestHandler invocation</h3>
<ul>
<li>Since 2.1.0</li>
</ul>
<p>When invoked as a <code>RequestHandlerInterface</code>, the <code>handle()</code> method will be invoked, and
passed a <code>ServerRequestInterface</code> instance <em>only</em>. If you need to return a response,
you will need to:</p>
<ul>
<li>Compose a response prototype in the middleware to use to build a response, or a
  canned response to return, OR</li>
<li>Create and return a concrete response type, OR</li>
<li>Operate on a response returned by invoking the delegate.</li>
</ul>
<h3 id="providing-an-altered-request">Providing an altered request:</h3>
<pre class="codehilite"><code class="language-php">// Standard invokable:
function ($request, $response, $next) use ($bodyParser)
{
    $bodyParams = $bodyParser($request);
    return $next(
        $request-&gt;withBodyParams($bodyParams), // Next will pass the new
        $response                              // request instance
    );
}

// http-interop/http-middleware &lt; 0.5 invokable:
function ($request, DelegateInterface $delegate) use ($bodyParser)
{
    $bodyParams = $bodyParser($request);

    // Delegate will receive the new request instance:
    return $delegate-&gt;process(
        $request-&gt;withBodyParams($bodyParams)
    );
}

// http-interop/http-middleware 0.5.0 invokable:
function ($request, RequestHandlerInterface $handler) use ($bodyParser)
{
    $bodyParams = $bodyParser($request);

    // Delegate will receive the new request instance:
    return $handler-&gt;handle(
        $request-&gt;withBodyParams($bodyParams)
    );
}</code></pre>

<h3 id="providing-an-altered-request-and-operating-on-the-returned-response">Providing an altered request and operating on the returned response:</h3>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next) use ($bodyParser)
{
    $response = $next(
        $request-&gt;withBodyParams($bodyParser($request)),
        $response
    );

    return $response-&gt;withAddedHeader('Cache-Control', [
}

// http-interop/http-middleware &lt; 0.5 invokable:
function ($request, DelegateInterface $delegate) use ($bodyParser)
{
    $bodyParams = $bodyParser($request);

    // Provide a new request instance to the delegate:
    return $delegate-&gt;process(
        $request-&gt;withBodyParams($bodyParams)
    );
}

// http-interop/http-middleware 0.5.0 invokable:
function ($request, RequestHandlerInterface $handler) use ($bodyParser)
{
    $bodyParams = $bodyParser($request);

    // Provide a new request instance to the delegate:
    return $handler-&gt;handle(
        $request-&gt;withBodyParams($bodyParams)
    );
}</code></pre>

<h3 id="returning-a-response-to-complete-the-request">Returning a response to complete the request</h3>
<p>If your middleware does not need to delegate to another layer, it's time to
return a response.</p>
<p>While we pass a response when using <code>Next</code> as a functor, we recommend creating
a new response, or providing your middleware with a response prototype; this
will ensure that the response is specific for your context.</p>
<pre class="codehilite"><code class="language-php">$prototype = new Response();

// Standard invokable signature:
function ($request, $response, $next) use ($prototype)
{
    $response = $prototype-&gt;withAddedHeader('Cache-Control', [
        'public',
        'max-age=18600',
        's-maxage=18600',
    ]);

    return $response;
}

// http-interop/http-middleware &lt; 0.5 invokable signature:
function ($request, DelegateInterface $delegate) use ($prototype)
{
    $response = $prototype-&gt;withAddedHeader('Cache-Control', [
        'public',
        'max-age=18600',
        's-maxage=18600',
    ]);
}

// http-interop/http-middleware 0.5.0 invokable signature:
function ($request, RequestHandlerInterface $handler) use ($prototype)
{
    $response = $prototype-&gt;withAddedHeader('Cache-Control', [
        'public',
        'max-age=18600',
        's-maxage=18600',
    ]);
}</code></pre>

<h3 id="delegation">Delegation</h3>
<p>If your middleware is not capable of returning a response, or a particular path
in the middleware cannot return a response, return the result of executing the
delegate.</p>
<p>When using the legacy middleware signature, invoke the <code>$next</code> argument:</p>
<pre class="codehilite"><code class="language-php">return $next($request, $response);</code></pre>

<p>If you are using <code>http-interop/http-middleware</code> in versions lower than 0.5.0,
then the delegate implements <code>DelegateInterface</code>; invoke its <code>process()</code> method:</p>
<pre class="codehilite"><code class="language-php">return $delegate-&gt;process($request);</code></pre>

<p>If you are using <code>http-interop/http-middleware</code> versions 0.5.0 or above, then
the delegate implements <code>RequestHandlerInterface</code>; invoke its <code>handle()</code> method:</p>
<pre class="codehilite"><code class="language-php">return $handler-&gt;handle($request);</code></pre>

<p><strong>Middleware should always return a response, and, if it cannot, return the
result of delegation.</strong></p>
<h3 id="raising-an-error-condition">Raising an error condition</h3>
<p>If your middleware cannot complete &mdash; perhaps a database error occurred, a
service was unreachable, etc. &mdash; how can you report the error?</p>
<p>Raise an exception!</p>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next) use ($service)
{
    $result = $service-&gt;fetchSomething();
    if (! $result-&gt;isSuccess()) {
        throw new RuntimeException('Error fetching something');
    }

    /* ... otherwise, complete the request ... */
}</code></pre>

<p>Use the <a href="../error-handlers/#handling-php-errors-and-exceptions">ErrorHandler middleware</a>
to handle exceptions thrown by your middleware and report the error condition to
your users.</p>
<h2 id="http-messages">HTTP Messages</h2>
<h3 id="zendstratigilityhttprequest">Zend\Stratigility\Http\Request</h3>
<ul>
<li>Deprecated in 1.3.0; to be removed in 2.0.0.</li>
</ul>
<p><code>Zend\Stratigility\Http\Request</code> acts as a decorator for a <code>Psr\Http\Message\ServerRequestInterface</code>
instance. The primary reason is to allow composing middleware such that you always have access to
the original request instance.</p>
<p>As an example, consider the following:</p>
<pre class="codehilite"><code class="language-php">$app1 = new Middleware();
$app1-&gt;pipe('/foo', $fooCallback);

$app2 = new Middleware();
$app2-&gt;pipe('/root', $app1);

$server = Server::createServer($app2 /* ... */);</code></pre>

<p>In the above, if the URI of the original incoming request is <code>/root/foo</code>, what <code>$fooCallback</code> will
receive is a URI with a past consisting of only <code>/foo</code>. This practice ensures that middleware can be
nested safely and resolve regardless of the nesting level.</p>
<p>If you want access to the full URI — for instance, to construct a fully qualified URI to your
current middleware — <code>Zend\Stratigility\Http\Request</code> contains a method, <code>getOriginalRequest()</code>,
which will always return the original request provided to the application:</p>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next)
{
    $location = $request-&gt;getOriginalRequest()-&gt;getUri()-&gt;getPath() . '/[:id]';
    $response = $response-&gt;setHeader('Location', $location);
    $response = $response-&gt;setStatus(302);
    return $response;
}</code></pre>

<h3 id="zendstratigilityhttpresponse">Zend\Stratigility\Http\Response</h3>
<ul>
<li>Deprecated in 1.3.0; to be removed in 2.0.0.</li>
</ul>
<p><code>Zend\Stratigility\Http\Response</code> acts as a decorator for a <code>Psr\Http\Message\ResponseInterface</code>
instance, and also implements <code>Zend\Stratigility\Http\ResponseInterface</code>, which provides the
following convenience methods:</p>
<ul>
<li><code>write()</code>, which proxies to the <code>write()</code> method of the composed response stream.</li>
<li><code>end()</code>, which marks the response as complete; it can take an optional argument, which, when
  provided, will be passed to the <code>write()</code> method. Once <code>end()</code> has been called, the response is
  immutable and will throw an exception if a state mutating method like <code>withHeader</code> is called.</li>
<li><code>isComplete()</code> indicates whether or not <code>end()</code> has been called.</li>
</ul>
<p>Additionally, it provides access to the original response created by the server via the method
<code>getOriginalResponse()</code>.</p>
<h2 id="middleware_1">Middleware</h2>
<p>Stratigility provides several concrete middleware implementations.</p>
<h4 id="errorhandler-and-notfoundhandler">ErrorHandler and NotFoundHandler</h4>
<p>These two middleware allow you to provide handle PHP errors and exceptions, and
404 conditions, respectively. You may read more about them in the
<a href="../error-handlers/">error handling chapter</a>.</p>
<h3 id="originalmessages">OriginalMessages</h3>
<p>This callable middleware can be used as the outermost layer of middleware in
order to set the original request, URI, and response instances as request
attributes for inner layers. See the <a href="../migration/to-v2/#original-request-response-and-uri">migration chapter</a>
for more details.</p>
<h2 id="middleware-decorators">Middleware Decorators</h2>
<p>The following decorator classes are each in the <code>Zend\Stratigility\Middleware</code>
namespace, and fulfill the installed <code>MiddlewareInterface</code> based on the
http-interop/http-middleware version installed in your application.</p>
<p>You can manually decorate callable middleware using these decorators, or instead
let <code>MiddlewarePipe</code> do the work for you. To let <code>MiddlewarePipe</code> handle this,
however, you <em>must</em> compose a response prototype prior to piping middleware
using the double pass middleware signature.</p>
<h3 id="pathmiddlewaredecorator">PathMiddlewareDecorator</h3>
<ul>
<li>Since 2.2.0</li>
</ul>
<p>The <code>PathMiddlewareDecorator</code> can be used to segregate middleware by request URI
path prefix. This can be done for several purposes:</p>
<ul>
<li>To execute such middleware only if a given path prefix is matched; e.g.,
  if you have middleware you want to run for every URI that matches
  <code>/api</code> (e.g., to run rate limiting middleware).</li>
<li>To re-use an existing middleware that has its own internal routing under a
  specific path; e.g., a "shopping cart" middleware pipeline/application that
  you wish to run under the path <code>/store</code> on one site, but under <code>/shop</code> on
  another, while otherwise retaining the same functionality.</li>
</ul>
<p>The <code>PathMiddlewareDecorator</code> constructor accepts two arguments: a string path
prefix to match, and an http-interop <code>MiddlewareInterface</code> instance:</p>
<pre class="codehilite"><code class="language-php">$middleware = new PathMiddlewareDecorator('/api', $apiMiddleware);</code></pre>

<p>When the path prefix is matched in the current request, the decorator will
strip the path prefix from the request passed to the composed middleware.</p>
<p>If the middleware calls on the handler, the decorator will replace the request
URI's path with the path from the original request before invoking the handler.</p>
<h3 id="callablemiddlewaredecorator">CallableMiddlewareDecorator</h3>
<ul>
<li>Since 2.2.0</li>
</ul>
<p>This class will decorate any PHP callable middleware that follows the signatures
of either of the <code>MiddlewareInterface</code> from either the 0.4.1 or 0.5.0 version of
the http-interop/http-middleware package.</p>
<p>Typically, this looks like:</p>
<pre class="codehilite"><code class="language-php">function ($request, $handler) : Psr\Http\Message\ResponseInterface</code></pre>

<p>where <code>$handler</code> will either be of the type
<code>Interop\Http\ServerMiddleware\DelegateInterface</code> or
<code>Interop\Http\Server\RequestHandlerInterface</code>, depending on the http-interop
version used in your application.</p>
<p>The decorator receives the PHP callable as its sole constructor argument, and is
then suitable for piping into the application:</p>
<pre class="codehilite"><code class="language-php">use Zend\Stratigility\Middleware\CallableMiddlewareDecorator;

$pipeine-&gt;pipe(new CallableMiddlewareDecorator(function ($request, $handler) {
    // ...
}));</code></pre>

<p>This class is forwards compatible with version 3.</p>
<h3 id="doublepassmiddlewaredecorator">DoublePassMiddlewareDecorator</h3>
<ul>
<li>Since 2.2.0</li>
</ul>
<p>This class will decorate any PHP callable middleware that follows the "<a href="../creating-middleware/#double-pass-middleware">double
pass signature</a>double-pass"  as a
<code>MiddlewareInterface</code> implementation of either the 0.4.1 or 0.5.0 version of
http-interop.</p>
<p>Typically, this looks like:</p>
<pre class="codehilite"><code class="language-php">function ($request, $response, $next) : Psr\Http\Message\ResponseInterface</code></pre>

<p>where <code>$next</code> is a callable for invoking the next middleware layer, and expects</p>
<p>The decorator receives the PHP callable and a PSR-7 <code>ResponseInterface</code> instance
as its arguments, and is then suitable for piping into the application:</p>
<pre class="codehilite"><code class="language-php">use Zend\Stratigility\Middleware\DoublePassMiddlewareDecorator;

$pipeine-&gt;pipe(new DoublePassMiddlewareDecorator(
    function ($request, $response, $next) {
        // ...
    },
    $responsePrototype
));</code></pre>

<p>This class is forwards compatible with version 3.</p>
<h3 id="callableinteropmiddlewarewrapper">CallableInteropMiddlewareWrapper</h3>
<ul>
<li>Since 1.3.0</li>
<li>Deprecated since 2.2.0</li>
</ul>
<p>This is a middleware decorator for PHP callables that have a signature
compatible with http-interop/http-middleware version 0.4.1 or 0.5.0. Please see
the <a href="../creating-middleware/#callable-standards-signature-middleware">Creating Middleware standards-based callable middleware
documentation</a>.</p>
<h3 id="callablemiddlewarewrapper">CallableMiddlewareWrapper</h3>
<ul>
<li>Since 1.3.0</li>
<li>Deprecated since 2.2.0</li>
</ul>
<p>This is a middleware decorator for PHP callables that follow the <a href="../creating-middleware/#double-pass-middleware">double pass
signature</a>. If you plan use
double pass middleware in version 2.2.0 or later, we recommend using the
<a href="#doublepassmiddlewaredecorator"><code>DoublePassMiddlewareDecorator</code></a> instead.</p>
<h2 id="delegates">Delegates</h2>
<ul>
<li>Since 2.0.0</li>
<li>Deprecated since 2.2.0</li>
</ul>
<p>In addition to <code>Zend\Stratigility\Next</code>, Stratigility provides another
delegate/request handler implementation via 
<code>Zend\Stratigility\Delegate\CallableDelegateDecorator</code>. This class will work
with either http-interop/http-middleware 0.4.1 or 0.5.0, implementing the
<code>DelegateInterface</code> in the case of the former, or the <code>RequestHandlerInterface</code>
in the case of the latter.</p>
<p>This class can be used to wrap a callable <code>$next</code> instance for use in passing to
an http-interop/http-middleware middleware interface <code>process()</code> method as a
delegate; the primary use case is adapting functor middleware to work as
http-interop middleware.</p>
<p>As an example:</p>
<pre class="codehilite"><code class="language-php">// http-interop/http-middleware 0.2:
use Interop\Http\Middleware\DelegateInterface;
use Interop\Http\Middleware\ServerMiddlewareInterface;

// http-interop/http-middleware 0.4.1:
use Interop\Http\ServerMiddleware\DelegateInterface;
use Interop\Http\ServerMiddleware\MiddlewareInterface as ServerMiddlewareInterface;

// http-interop/http-middleware 0.5.0:
use Interop\Http\Server\MiddlewareInterface as ServerMiddlewareInterface;
use Interop\Http\Server\RequestHandlerInterface as DelegateInterface;

use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Zend\Stratigility\Delegate\CallableDelegateDecorator;

class TimestampMiddleware implements ServerMiddlewareInterface
{
    public function __invoke(
        ServerRequestInterface $request,
        ResponseInterface $response,
        callable $next
    ) {
        return $this-&gt;process($request, new CallableDelegateDecorator($next, $response));
    }

    public function process(
        ServerRequestInterface $request,
        DelegateInterface $delegate
    ) {
        // http-interop/http-middleware &lt; 0.5
        $response = $delegate-&gt;process($request);

        // http-interop/http-middleware 0.5.0
        $response = $delegate-&gt;handle($request);

        return $response-&gt;withHeader('X-Processed-Timestamp', time());
    }
}</code></pre>

<h2 id="utility-functions">Utility Functions</h2>
<p>Stratigility provides the following utility functions.</p>
<h3 id="path">path</h3>
<p><pre class="codehilite"><code>function Zend\Stratigility\path(
    string $pathPrefix,
    Interop\Http\Server\MiddlewareInterface|Interop\Http\ServerMiddleware\MiddlewareInterface $middleware
) : Zend\Stratigility\Middleware\PathMiddlewareDecorator
```

`path()` provides a convenient way to perform path segregation when piping your
middleware.

```php
$pipeline-&gt;pipe(path('/foo', $middleware));
```

### middleware
</code></pre>
function Zend\Stratigility\middleware(
    callable $middleware
) : Zend\Stratigility\Middleware\CallableMiddlewareDecorator
<pre class="codehilite"><code>
`middleware()` provides a convenient way to decorate callable middleware that
implements the PSR-15 middleware signature when piping it to your application.

```php
$pipeline-&gt;pipe(middleware(function ($request, $handler) {
  // ...
});</code></pre></p>
<h3 id="doublepassmiddleware">doublePassMiddleware</h3>
<p><code>`
function Zend\Stratigility\doublePassMiddleware(
    callable $middleware,
    Psr\Http\Message\ResponseInterface $responsePrototype = null
) : Zend\Stratigility\Middleware\DoublePassMiddlewareDecorator</code></p>
<p><code>doublePassiddleware()</code> provides a convenient way to decorate middleware that
implements the double pass middleware signature when piping it to your application.</p>
<p><code>php
$pipeline-&gt;pipe(doublePassMiddleware(function ($request, $response, $next) {
  // ...
});</code></p>
<p>If you are not using zend-diactoros as a PSR-7 implementation, you will need to
pass a response prototype as well:</p>
<p><code>php
$pipeline-&gt;pipe(doublePassMiddleware(function ($request, $response, $next) {
  // ...
}, $response);</code></p>

<hr />


<nav>
  <ul class="pager hidden-print">
    <li class="previous">
      <a rel="prev" href="../executing-middleware/"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next">
      <a rel="next" href="../migration/to-v2/">Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav>
</div>
        
    </div>
    <!-- content:end -->

    <div id="footerwrap">
    <div class="container">
        <div class="row site-map">
            <div class="col-lg-3">
              <p>
                <strong>Zend Framework</strong><br />
                <a href="https://framework.zend.com/">framework.zend.com</a><br />
                <a href="https://docs.zendframework.com">docs.zendframework.com</a><br />
                <a href="https://packages.zendframework.com">packages.zendframework.com</a><br />
                <a href="https://apigility.org">apigility.org</a><br />
              </p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 centered">
                <a class="back-to-top" href="#page-top"><i class="fa fa-chevron-circle-up fa-4" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="spacing"></div>

        <div class="row">
            <div class="col-lg-8">
                <h4>Copyright</h4>
                <div class="hline-w"></div>

                <p>&copy; 2006-2017 by <a href="https://www.zend.com/">Zend</a>, a <a href="https://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            <div class="col-lg-4">
                <h4>Contacts</h4>
                <div class="hline-w"></div>
                <p>
                    <a href="https://discourse.zendframework.com" class="btn-social btn-outline" alt="Forum" title="Forum"><i class="fa fa-comments"></i></a>
                    <a href="https://zendframework-slack.herokuapp.com" class="btn-social btn-outline" alt="Slack" title="Slack"><i class="fa fa-slack"></i></a>
                    <a href="https://github.com/zendframework" class="btn-social btn-outline" alt="Github" title="Github"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/zfdevteam" class="btn-social btn-outline" alt="Twitter" title="Twitter"><i class="fa fa-twitter"></i></a>
                </p>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <script>var base_url = '..';</script>
    <script src="../js/scripts-0b6185f4a5.js"></script>
    <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../search/require.js"></script>
        <script src="../search/search.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div class="zf-components">
  <div class="zf-components-grid">
    <div class="zf-logo">
      <a href="https://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../img/zf-logo-mark.svg" alt="Zend Framework" width="250" /></a>
    </div>

    <div class="component-list"></div>

    <p class="zf-components-rollup"><a href="#">Hide list</a></p>
  </div>
</div>

</body>


</html>
