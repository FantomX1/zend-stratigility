<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="zend-stratigility">  
    <link rel="shortcut icon" href="../img/favicon.ico">

    <title>Creating Middleware - zend-stratigility</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/styles-288837cc22.css">

    
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <span class="navbar-brand">
                <a class="logo-link" href="https://framework.zend.com/" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../img/zf-logo-mark.svg" height="28" alt="Zend Framework" /></a>
                <a href="..">zend-stratigility</a>
            </span>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                
                
                    <li >
                        <a href="../intro/">Intro</a>
                    </li>
                
                
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            

<li >
    <a href="../install/">Installation and Requirements</a>
</li>


                        
                            

<li >
    <a href="../usage/">Usage</a>
</li>


                        
                            

<li >
    <a href="../middleware/">Middleware</a>
</li>


                        
                            

<li >
    <a href="../error-handlers/">Error Handlers</a>
</li>


                        
                            

<li class="active">
    <a href="./">Creating Middleware</a>
</li>


                        
                            

<li >
    <a href="../executing-middleware/">Composing middleware</a>
</li>


                        
                            

<li >
    <a href="../api/">API Reference</a>
</li>


                        
                            

  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Migration</a>
    <ul class="dropdown-menu">
        
            

<li >
    <a href="../migration/to-v2/">To Version 2</a>
</li>


        
            

<li >
    <a href="../migration/preparing-for-v3/">Preparing for Version 3</a>
</li>


        
    </ul>
  </li>


                        
                        </ul>
                    </li>
                
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" class="component-toggle" data-toggle="tooltip" data-placement="bottom" title="Show component list">
                        <i class="fa fa-book"></i> Components
                    </a>
                </li>

                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li>
                        <a href="https://github.com/zendframework/zend-stratigility/">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <!-- content:begin -->
    <div id="page-top" class="container docs">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#creating-middleware">Creating Middleware</a></li>
        
            <li><a href="#middlewareinterface">MiddlewareInterface</a></li>
        
            <li><a href="#callable-standards-signature-middleware">Callable standards-signature middleware</a></li>
        
            <li><a href="#double-pass-middleware">Double Pass Middleware</a></li>
        
    
    </ul>

    
    <ul class="pager hidden-print">
      <li class="previous">
        <a rel="prev" href="../error-handlers/"><i class="fa fa-arrow-left"></i> Previous</a>
      </li>
      <li class="next">
        <a rel="next" href="../executing-middleware/">Next <i class="fa fa-arrow-right"></i></a>
      </li>
    </ul>
    
</div></div>
        <div class="col-md-9" role="main">

<ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="..">zend-stratigility</a></li>
  
    
      
        <li>Reference</li>
      
    
  
  <li class="active">Creating Middleware</li>
</ol>

<h1 id="creating-middleware">Creating Middleware</h1>
<p>Stratigility provides several ways to write middleware:</p>
<ul>
<li>By implementing a standard interface.</li>
<li>By writing a PHP callable that uses the same signature as the standard
  interface.</li>
<li>By writing a PHP callable accepting standard PSR-7 messages.</li>
</ul>
<p>This document catalogs each of these, and includes pros and cons for each
pattern.</p>
<p>In all cases, middleware can do each (or all!) of the following:</p>
<ul>
<li>Examine a request, and return a response if certain requirements
  are (or are not!) met.</li>
<li>Delegate handling (and thus response generation) to the next layer.</li>
<li>Manipulate the response returned by a lower layer, and return the modified
  version.</li>
</ul>
<p>With each of the types below, we will demonstrate the same example: using an
external router instance to attempt to route a request and delegate to the
middleware matched.</p>
<h2 id="middlewareinterface">MiddlewareInterface</h2>
<ul>
<li>Since 1.3.0</li>
</ul>
<p>The <a href="http://www.php-fig.org">PHP-FIG standards body</a> identifies and ratifies
standards for community use. One of these,
<a href="http://www.php-fig.org/psr/psr-7/">PSR-7</a> is used by Stratigility to provide
standard HTTP message interfaces.</p>
<p>Another, the proposed <a href="https://github.com/php-fig/fig-standards/tree/4b417c91b89fbedaf3283620ce432b6f51c80cc0/proposed/http-handlers">PSR-15 (HTTP Server Request
Handlers)</a>,
defines interfaces for handling and producing these messages.</p>
<p>The specification has undergone several revisions via its working group, and
this version of Stratigility supports the following:</p>
<ul>
<li><a href="https://github.com/http-interop/http-middleware/releases/tag/0.4.1">http-interop/http-middleware v0.4.1</a></li>
<li><a href="https://github.com/http-interop/http-middleware/releases/tag/0.5.0">http-interop/http-middleware v0.5.0</a></li>
</ul>
<p>The two use different namespaces, and the intermediary interface is named
differently between the two (and defines a different method).</p>
<p>If you are new to Stratigility, we suggest using the latest version of the spec,
as it is closest to how the final PSR-15 specificaion defines the interfaces,
and will only require changing the namespace from which you import the
interfaces later. If you are upgrading, however, choose the 0.4.1 version to
retain existing compatibility.</p>
<p>When writing middleware targeting http-middleware 0.4.1, define your middleware
as follows:</p>
<pre class="codehilite"><code class="language-php">use Interop\Http\ServerMiddleware\DelegateInterface;
use Interop\Http\ServerMiddleware\MiddlewareInterface;
use Psr\Http\Message\ServerRequestInterface;

class MyMiddleware implements MiddlewareInterface
{
    private $router;

    public function __construct($router)
    {
        $this-&gt;router = $router;
    }

    public function process(ServerRequestInterface $request, DelegateInterface $delegate)
    {
        $path = $request-&gt;getUri()-&gt;getPath();

        // Route the path
        $route = $this-&gt;router-&gt;route($path);
        if (! $route) {
            return $delegate-&gt;process($request);
        }

        $middleware = $route-&gt;getHandler();
        return $middleware-&gt;process($request, $delegate);
    }
}</code></pre>

<p>Under http-middleware 0.5.0, the example becomes the following:</p>
<pre class="codehilite"><code class="language-php">use Interop\Http\Server\MiddlewareInterface;
use Interop\Http\Server\RequestHandlerInterface;
use Psr\Http\Message\ServerRequestInterface;

class MyMiddleware implements MiddlewareInterface
{
    private $router;

    public function __construct($router)
    {
        $this-&gt;router = $router;
    }

    public function process(ServerRequestInterface $request, RequestHandlerInterface $handler)
    {
        $path = $request-&gt;getUri()-&gt;getPath();

        // Route the path
        $route = $this-&gt;router-&gt;route($path);
        if (! $route) {
            return $handler-&gt;handle($request);
        }

        $middleware = $route-&gt;getHandler();
        return $middleware-&gt;process($request, $delegate);
    }
}</code></pre>

<p>Note that the primary difference is the change from <code>DelegateInterface</code> to
<code>RequestHandlerInterface</code>; also note that the method each defines is different
(<code>process</code> vs <code>handle</code>).</p>
<h2 id="callable-standards-signature-middleware">Callable standards-signature middleware</h2>
<ul>
<li>Since 1.3.0: <code>CallableInteropMiddlewareWrapper</code></li>
<li>Since 2.2.0: <code>CallableMiddlewareDecorator</code></li>
<li>Deprecated since 2.2.0: <code>CallableInteropMiddlewareWrapper</code></li>
</ul>
<p>You may also write PHP callables that fulfill the http-middleware interface
signatures as defined in the previous section.</p>
<p>If your middleware satisfies the http-interop 0.4.1 signature (which, in this
case, means that it expects a <code>DelegateInterface</code>, and will call its <code>process()</code>
method), use <code>CallableInteropMiddlewareWrapper</code>:</p>
<pre class="codehilite"><code class="language-php">use Interop\Http\ServerMiddleware\DelegateInterface;
use Zend\Stratigility\Middleware\CallableInteropMiddlewareWrapper;

$pipeline-&gt;pipe(new CallableInteropMiddlewareWrapper(
    function ($request, $delegate) use ($router) {
        $path = $request-&gt;getUri()-&gt;getPath();

        // Route the path
        $route = $router-&gt;route($path);
        if (! $route) {
            return $delegate-&gt;process($request);
        }

        $middleware = $route-&gt;getHandler();
        return $middleware-&gt;process($request, $delegate);
    }
))</code></pre>

<p>Starting in 2.0, when you pipe such middleware directly to <code>MiddlewarePipe</code>, it
internally decorates it for you using this class.</p>
<blockquote>
<h3 id="callableinteropmiddlewarewrapper-deprecated">CallableInteropMiddlewareWrapper deprecated</h3>
<p>The <code>CallableInteropMiddlewareWrapper</code> is deprecated starting in version
2.2.0, and will be removed entirely for version 3.0.0. We recommend updating
your code to use the <code>CallableMiddlewareDecorator</code> to make your code
future-proof.</p>
<p>If possible, also upgrade to http-interop/http-middleware 0.5.0, and use the
<code>handle()</code> method of the <code>$handler</code> argument. </p>
</blockquote>
<p>If your middleware satisfies the http-interop 0.5.0 signature (which, in this
case, means that it expects a <code>RequestHandlerInterface</code>, and will call its
<code>handle()</code> method), use <code>CallableMiddlewareDecorator</code>:</p>
<pre class="codehilite"><code class="language-php">use Interop\Http\ServerMiddleware\DelegateInterface;
use Zend\Stratigility\Middleware\CallableMiddlewareDecorator;

$pipeline-&gt;pipe(new CallableMiddlewareDecorator(
    function ($request, $handler) use ($router) {
        $path = $request-&gt;getUri()-&gt;getPath();

        // Route the path
        $route = $router-&gt;route($path);
        if (! $route) {
            return $handler-&gt;handle($request);
        }

        $middleware = $route-&gt;getHandler();
        return $middleware-&gt;process($request, $delegate);
    }
))</code></pre>

<p>Starting in 2.2.0, when you pipe such middleware directly to <code>MiddlewarePipe</code>,
it internally decorates it for you using this class.</p>
<h2 id="double-pass-middleware">Double Pass Middleware</h2>
<ul>
<li>Since 1.0.0: piping double-pass middleware directly</li>
<li>Since 1.3.0: <code>CallableMiddlewareWrapper</code> since 1.3.0; deprecated in 2.2.0</li>
<li>Since 2.2.0: <code>DoublePassMiddlewareDecorator</code></li>
<li>Deprecated since 2.2.0: piping double-pass middleware directly</li>
<li>Deprecated since 2.2.0: <code>CallableMiddlewareWrapper</code></li>
</ul>
<p>The last style of middleware is called "double pass" middleware.</p>
<p>The signature of such middleware is as follows:</p>
<pre class="codehilite"><code class="language-php">function (
    ServerRequestInterface $request,
    ResponseInterface $response,
    callable $next
)</code></pre>

<p>where the callable is expected to return a PSR-7 <code>ResponseInterface</code>, and where
<code>$next</code> has the following signature:</p>
<pre class="codehilite"><code class="language-php">function (
    ServerRequestInterface $request,
    ResponseInterface $response
)</code></pre>

<p>and is also expected to return a response.</p>
<p>This latter function is the basis for the name "double pass"; you pass <em>both</em> a
request <em>and</em> a response to the next layer.</p>
<p>Neither the callable arguments nor the return value need typehints, though we
recommend them for type safety.</p>
<p>In versions prior to 2.0, you could pipe double-pass middleware directly to the
pipeline:</p>
<pre class="codehilite"><code class="language-php">$pipeline-&gt;pipe(function ($request, $response, $next) {});</code></pre>

<p>While this usage is still possible in the v2 series, we recommend against using
it for two reasons:</p>
<ul>
<li>Version 3 will no longer support direct piping of such middleware.</li>
<li>The signature does not follow the PSR-15 standards, making the middleware
  non-portable to other PSR-15 middleware dispatcher stacks.</li>
</ul>
<p>As such, we provide options for you to decorate such middleware.</p>
<blockquote>
<h3 id="do-not-operate-on-the-response">Do not operate on the response</h3>
<p>If you are creating double pass middleware, do not use the <code>$response</code>
argument passed to the middleware as anything other than a prototype
from which to build a response to return from the method.</p>
<p>If you manipulate the response before passing it to the next layer, the next
layer may choose to return a completely different response; in the case of
standards-based middleware, it will never even receive the instance!</p>
<p>If changes to the response are necessary, operate only on the response
<em>returned</em> by the next layer.</p>
</blockquote>
<h3 id="callablemiddlewarewrapper">CallableMiddlewareWrapper</h3>
<ul>
<li>Since 1.3.0</li>
<li>Deprecated since 2.2.0</li>
</ul>
<p>Our first double-pass middleware decorator is
<code>Zend\Stratigility\Middleware\CallableMiddlewareWrapper</code>, which implements
either the http-middleware 0.4.1 or 0.5.0 <code>MiddlewareInterface</code>, depending on
what is installed:</p>
<pre class="codehilite"><code class="language-php">$pipeline-&gt;pipe(new CallableMiddlewareWrapper(
    function ($request, $response, $next) {},
    $responsePrototype
));</code></pre>

<p>The <code>$responsePrototype</code> argument is required, as without it, there is no
response instance to pipe to the decorated middleware.</p>
<p>Starting in 2.0, if you pipe such middleware directly to <code>MiddlewarePipe</code>, it
internally decorates it for you, as long as the pipeline also composes a
response prototype:</p>
<pre class="codehilite"><code class="language-php">$pipeline-&gt;setResponsePrototype(new Response());
$pipeline-&gt;pipe($doublePassMiddleware);</code></pre>

<p>We recommend always decorating the middleware manually. We also recommend
migrating to the <code>DoublePassMiddlewareDecorator</code> to make your code forwards
compatible with version 3.</p>
<h3 id="doublepassmiddlewaredecorator">DoublePassMiddlewareDecorator</h3>
<ul>
<li>Since 2.2.0</li>
</ul>
<p><code>Zend\Stratigility\Middleware\DoublePassMiddlewareDecorator</code> implements the
http-middleware 0.5.0 <code>MiddlewareInterface</code>, and will be updated in version 3 to
implement the PSR-15 <code>MiddlewareInterface</code>:</p>
<pre class="codehilite"><code class="language-php">$pipeline-&gt;pipe(new CallableMiddlewareWrapper(
    function ($request, $response, $next) {},
    $responsePrototype
));</code></pre>

<p>As with the <code>CallableMiddlewareWrapper</code>, the <code>$responsePrototype</code> argument is
required, as without it, there is no response instance to pipe to the decorated
middleware.</p>
<p>Starting in version 2.2.0, piping double pass middleware directly to
<code>MiddlewarePipe</code> internally decorates it using the
<code>DoublePassMiddlewareDecorator</code> internally, so long as you have also already
composed a response prototype in the <code>MiddlewarePipe</code> instance.</p>

<hr />


<nav>
  <ul class="pager hidden-print">
    <li class="previous">
      <a rel="prev" href="../error-handlers/"><i class="fa fa-arrow-left"></i> Previous</a>
    </li>
    <li class="next">
      <a rel="next" href="../executing-middleware/">Next <i class="fa fa-arrow-right"></i></a>
    </li>
  </ul>
</nav>
</div>
        
    </div>
    <!-- content:end -->

    <div id="footerwrap">
    <div class="container">
        <div class="row site-map">
            <div class="col-lg-3">
              <p>
                <strong>Zend Framework</strong><br />
                <a href="https://framework.zend.com/">framework.zend.com</a><br />
                <a href="https://docs.zendframework.com">docs.zendframework.com</a><br />
                <a href="https://packages.zendframework.com">packages.zendframework.com</a><br />
                <a href="https://apigility.org">apigility.org</a><br />
              </p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12 centered">
                <a class="back-to-top" href="#page-top"><i class="fa fa-chevron-circle-up fa-4" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="spacing"></div>

        <div class="row">
            <div class="col-lg-8">
                <h4>Copyright</h4>
                <div class="hline-w"></div>

                <p>&copy; 2006-2017 by <a href="https://www.zend.com/">Zend</a>, a <a href="https://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            <div class="col-lg-4">
                <h4>Contacts</h4>
                <div class="hline-w"></div>
                <p>
                    <a href="https://discourse.zendframework.com" class="btn-social btn-outline" alt="Forum" title="Forum"><i class="fa fa-comments"></i></a>
                    <a href="https://zendframework-slack.herokuapp.com" class="btn-social btn-outline" alt="Slack" title="Slack"><i class="fa fa-slack"></i></a>
                    <a href="https://github.com/zendframework" class="btn-social btn-outline" alt="Github" title="Github"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/zfdevteam" class="btn-social btn-outline" alt="Twitter" title="Twitter"><i class="fa fa-twitter"></i></a>
                </p>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@2.2.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <script>var base_url = '..';</script>
    <script src="../js/scripts-0b6185f4a5.js"></script>
    <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../search/require.js"></script>
        <script src="../search/search.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div class="zf-components">
  <div class="zf-components-grid">
    <div class="zf-logo">
      <a href="https://framework.zend.com" data-toggle="tooltip" data-placement="bottom" title="Go to the ZF homepage"><img src="../img/zf-logo-mark.svg" alt="Zend Framework" width="250" /></a>
    </div>

    <div class="component-list"></div>

    <p class="zf-components-rollup"><a href="#">Hide list</a></p>
  </div>
</div>

</body>


</html>
